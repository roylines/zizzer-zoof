/*zizzer-zoof: Copyright (C) 2012-2014, Roy Lines, http://roylines.co.uk*/
var app=angular.module("app",["ngRoute","services"]),services=angular.module("services",["ngResource"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function(a,b,c){b.html5Mode(!0);for(var d=["login","selling","signup"],e=0;e<d.length;++e){var f={templateUrl:"/partial/"+d[e],controller:d[e]};a.when("/"+d[e],f)}a.otherwise({redirectTo:"/signup"});var g=["$q",function(a){function b(a){return a}function c(b){var c=b.status;return 401==c?(window.location="/signup",void 0):a.reject(b)}return function(a){return a.then(b,c)}}];c.responseInterceptors.push(g)}]),services.factory("Login",["$resource",function(a){return a("/api/1/login")}]),services.factory("Logout",["$resource",function(a){return a("/api/1/logout")}]),services.factory("Items",["$resource",function(a){return a("/api/1/items/:id")}]),services.factory("Users",["$resource",function(a){return a("/api/1/users")}]),app.directive("fileInput",["$parse",function(){return{restrict:"EA",template:"<input class='hidden' type='file' name='image' accept='image/*' capture='camera' />",replace:!0,link:function(a,b,c){a.$watch("state",function(){"choose"==a.state&&(a.state="choosing",b[0].click())}),b.bind("change",function(b){a[c.onChange](b.target.files[0])})}}}]),app.directive("map",[function(){return{restrict:"EA",template:"<div class='map'></div>",replace:!0,link:function(a,b,c){var d=function(){return a[c.zoom||"zoom"]||10},e=function(){var b=a[c.center||"center"];return new google.maps.LatLng(b.lat,b.lng)},f={zoom:d(),center:e()},g=new google.maps.Map(b[0],f);a.$watch(c.center||"center",function(){g.setCenter(e())},!0)}}}]),app.controller("login",["$scope","$location","Login",function(a,b,c){a.busy=!1;var d=function(){b.path("/selling")},e=function(b){a.error=b.data,a.busy=!1};a.login=function(b,f){a.busy=!0;var g={email:b,password:f};c.save({},g,d,e)}}]),app.controller("selling",["$scope","Items",function(a,b){a.state="idle",a.choose=function(){a.state="choose"},a.chosen=function(b){var c=new FileReader;c.onloadend=function(){a.$apply(function(){a.newImage=c.result,a.state="chosen"})},c.readAsDataURL(b)},a.forSale=b.query({status:"selling"})}]),app.controller("signup",["$scope","$location","Users",function(a,b,c){a.center={lat:-34.397,lng:150.644};var d=function(){b.path("/selling")},e=function(b){a.error=b.data,a.busy=!1},f=function(b,c){a.$apply(function(){a.busy=!1,c==google.maps.GeocoderStatus.OK?(console.log(b),a.formatted_address=b[0].formatted_address,a.center={lat:b[0].geometry.location.b,lng:b[0].geometry.location.d}):a.error=c})};a.search=function(b){a.busy=!0;var c=new google.maps.Geocoder;c.geocode({address:b},f)},a.signup=function(b,f){a.busy=!0;var g={email:b,password:f};c.save({},g,d,e)}}]),app.controller("topbar",["$scope","$location","Logout",function(a,b,c){a.logout=function(){c.query(),b.path("/login")}}]);